{% extends "partials/base.html" %}
{% load crispy_forms_tags %}

{% block main %}

<style>
.main-content {
    padding: 15px;
    padding-left: 350px !important;
    width: 100%;
}

.price-table th, .price-table td {
    padding: 4px 6px !important;
    vertical-align: middle !important;
    font-size: 12px;
    white-space: nowrap;
}

.price-table input,
.price-table select {
    width: 120px;
    height: 26px;
    font-size: 12px;
}

.btn-xxs {
    padding: 3px 6px;
    font-size: 11px;
}

.price-box {
    border: 1px solid #ddd;
    background: #fafafa;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 18px;
}

.table-wrap {
    width: 100%;
    overflow-x: auto;
}

.filter-input, .filter-select {
    width: 100%;
    box-sizing: border-box;
    padding: 2px 4px;
    font-size: 12px;
}

</style>

<div class="main-content">

    <!-- TOP BUTTON -->
    <button id="btn-new-price" type="button" class="btn btn-primary mb-3">
        + New Price List
    </button>

    <!-- PRICE ENTRY SECTION -->
    <div id="price-entry-area" class="price-box" style="display:none;">
        <h5>Add Price Items</h5>

        <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}

            <button type="button" id="add-item-price" class="btn btn-secondary btn-xxs mb-2">
                + Add Item Price
            </button>

            <div class="table-wrap">
                <table class="table table-bordered price-table">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Seq</th>
                            <th>Price Code</th>
                            <th>Customer Group</th>
                            <th>Twine</th>
                            <th>Mesh Start</th>
                            <th>Mesh End</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>

                    </thead>

                    <tbody id="price-tbody">
                        {% for form in formset %}
                        <tr class="price-row">
                            <td>{{ form.product }}</td>
                            <td>{{ form.sequence_id }}</td>
                            <td>{{ form.code }}</td>
                            <td>{{ form.customer_group }}</td>
                            <td>{{ form.twine_code }}</td>
                            <td>{{ form.mesh_size_start }}</td>
                            <td>{{ form.mesh_size_end }}</td>
                            <td>{{ form.price }}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-warning btn-xxs clear-row">Clr</button>
                                <button type="button" class="btn btn-danger btn-xxs delete-row">Del</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="submit" class="btn btn-success mt-2">Save Price Catalog</button>
        </form>
    </div>

    <!-- SAVED PRICE LIST -->
    <h5>Saved Price Details</h5>
    <div class="table-wrap">
        <table class="table table-striped table-bordered price-table">
            <thead class="table-secondary">
                <tr>
                    <th>
                        <select class="filter-select" data-col="0">
                            <option value="">All Products</option>
                            {% for item in filter_header.product_names %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}

                        </select>
                    </th>
                    <th><input type="text" class="filter-input" placeholder="Seq" data-col="1"></th>
                    <th><input type="text" class="filter-input" placeholder="Price Code" data-col="2"></th>
                    <th>
                        <select class="filter-select" data-col="3">
                            <option value="">All Customer Groups</option>
                            {% for item in filter_header.customer_groups %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th>
                        <select class="filter-select" data-col="4">
                            <option value="">All Twines</option>
                            {% for item in filter_header.twine_codes %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th><input type="text" class="filter-input" placeholder="Mesh Start" data-col="5"></th>
                    <th><input type="text" class="filter-input" placeholder="Mesh End" data-col="6"></th>
                    <th><input type="text" class="filter-input" placeholder="Price" data-col="7"></th>
                    <td class="text-center">
                        <a class="btn btn-warning btn-xxs" id="clear-filters">Clear Filter</a>
                    </td>
                </tr>
            </thead>

            <tbody>
                {% for p in saved_prices %}
                <tr>
                    <td>{{ p.product }}</td>
                    <td>{{ p.sequence_id }}</td>
                    <td>{{ p.code }}</td>
                    <td>{{ p.customer_group }}</td>
                    <td>{{ p.twine_code }}</td>
                    <td>{{ p.mesh_size_start }}</td>
                    <td>{{ p.mesh_size_end }}</td>
                    <td>{{ p.price }}</td>
                    <td class="text-center">
                        <a class="btn btn-primary btn-xxs">Load</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center text-muted small">No saved records</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
/* Show/hide entry box */
document.getElementById("btn-new-price").addEventListener("click", () => {
    const box = document.getElementById("price-entry-area");
    box.style.display = (box.style.display === "none") ? "block" : "none";
});

/* Add formset row */
document.getElementById("add-item-price").addEventListener("click", () => {
    const tbody = document.getElementById("price-tbody");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");
    let total = parseInt(totalForms.value);

    let lastRow = tbody.querySelector("tr.price-row:last-of-type");
    if (!lastRow) return alert("No row available to clone.");

    let newHTML = lastRow.outerHTML;
    newHTML = newHTML.replace(new RegExp(`form-${total - 1}`, "g"), `form-${total}`);
    newHTML = newHTML.replace(new RegExp(`id_form-${total - 1}`, "g"), `id_form-${total}`);

    tbody.insertAdjacentHTML("beforeend", newHTML);
    const newRow = tbody.querySelector("tr.price-row:last-of-type");

    newRow.querySelectorAll("input, select").forEach(el => {
        if (el.name.includes("sequence_id") || el.name.includes("DELETE")) return;
        el.value = "";
    });

    const seq = newRow.querySelector("input[name*='sequence_id']");
    if (seq) seq.value = total + 1;

    totalForms.value = total + 1;
});

/* Delete row */
document.addEventListener("click", e => {
    if (e.target.classList.contains("delete-row")) {
        const row = e.target.closest("tr.price-row");
        const del = row.querySelector("input[name*='DELETE']");
        if (del) del.checked = true;
        row.style.display = "none";
    }
});

/* Clear row */
document.addEventListener("click", e => {
    if (e.target.classList.contains("clear-row")) {
        const row = e.target.closest("tr.price-row");
        row.querySelectorAll("input, select").forEach(el => {
            if (el.name.includes("sequence_id") || el.name.includes("DELETE")) return;
            el.value = "";
        });
    }
});



function filterTable() {
    if (!table) return; // safety check

    const rows = table.querySelectorAll("tr");

    rows.forEach(row => {
        let show = true;

        filterInputs.forEach(input => {
            const colIndex = Number(input.dataset.col);
            const val = input.value.trim().toLowerCase();
            const cellVal = row.cells[colIndex].textContent.trim().toLowerCase();
            if (val && !cellVal.includes(val)) {
                show = false;
            }
        });

        filterSelects.forEach(select => {
            const val = select.value.trim().toLowerCase();
            const colIndex = Number(select.dataset.col);
            const cellVal = row.cells[colIndex].textContent.trim().toLowerCase();
            if (val && cellVal !== val) show = false;
        });

        row.style.display = show ? "" : "none";
    });
}

document.addEventListener("DOMContentLoaded", function() {
    filterInputs = document.querySelectorAll(".filter-input");
    filterSelects = document.querySelectorAll(".filter-select");
    table = document.querySelector(".table-striped.price-table tbody");

    // Input and select filters
    filterInputs.forEach(input => input.addEventListener("keyup", filterTable));
    filterSelects.forEach(select => select.addEventListener("change", filterTable));

    // Clear filter button
    const clearBtn = document.getElementById("clear-filters");
    clearBtn.addEventListener("click", () => {
        filterInputs.forEach(input => input.value = "");
        filterSelects.forEach(select => select.selectedIndex = 0);
        filterTable(); // call the common function
    });
});


</script>

{% endblock %}
