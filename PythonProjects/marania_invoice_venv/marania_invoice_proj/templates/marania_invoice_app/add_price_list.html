{% extends "partials/base.html" %}
{% load crispy_forms_tags %}

{% block main %}

<style>
.main-content {
    padding: 15px;
    padding-left: 350px !important;
    width: 100%;
}

.price-table th, .price-table td {
    padding: 4px 6px !important;
    vertical-align: middle !important;
    font-size: 12px;
    white-space: nowrap;
}

.price-table input,
.price-table select {
    width: 120px;
    height: 26px;
    font-size: 12px;
}

.btn-xxs {
    padding: 3px 6px;
    font-size: 11px;
}

.price-box {
    border: 1px solid #ddd;
    background: #fafafa;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 18px;
}

.table-wrap {
    width: 100%;
    overflow-x: auto;
}

.filter-input, .filter-select {
    width: 100%;
    box-sizing: border-box;
    padding: 2px 4px;
    font-size: 12px;
}
</style>

<div class="main-content">

    <button id="btn-new-price" type="button" class="btn btn-primary mb-3">
        + New Price List
    </button>

    <div id="price-entry-area" class="price-box" style="display:none;">
        <h5>Add Price Items</h5>

        <form method="post">
            {% csrf_token %}
            {{ formset.management_form }}

            <!-- <button type="button" id="add-item-price" class="btn btn-secondary btn-xxs mb-2">
                + Add Item Price
            </button> -->

            <button type="button" id="add-item-price" class="btn btn-secondary btn-xxs mb-2">+ Add Item Price</button>
            <button type="button" id="delete-price-list" class="btn btn-danger btn-xxs mb-2">Delete Price List</button>

            <div class="table-wrap">
                <table class="table table-bordered price-table">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Seq</th>
                            <th>Price Code</th>
                            <th>Customer Group</th>
                            <th>Twine</th>
                            <th>Mesh Start</th>
                            <th>Mesh End</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody id="price-tbody">
                        <!-- Initially no rows visible -->
                        {% for form in formset %}
                        <tr class="price-row" style="display:none;">
                            <td>{{ form.product }}</td>
                            <td>{{ form.sequence_id }}</td>
                            <td>{{ form.code }}</td>
                            <td>{{ form.customer_group }}</td>
                            <td>{{ form.twine_code }}</td>
                            <td>{{ form.mesh_size_start }}</td>
                            <td>{{ form.mesh_size_end }}</td>
                            <td>{{ form.price }}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-warning btn-xxs clear-row">Clr</button>
                                <button type="button" class="btn btn-danger btn-xxs delete-row">Del</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="submit" class="btn btn-success mt-2">Save Price Catalog</button>
        </form>
    </div>

    <!-- SAVED ITEMS -->
    <h5>Saved Price Details</h5>
    <div class="table-wrap">
        <table class="table table-striped table-bordered price-table">
            <thead class="table-secondary">
                <tr>
                    <th>
                        <select class="filter-select" data-col="0">
                            <option value="">All Products</option>
                            {% for item in filter_header.product_names %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th><input type="text" class="filter-input" placeholder="Seq" data-col="1"></th>
                    <th><input type="text" class="filter-input" placeholder="Price Code" data-col="2"></th>
                    <th>
                        <select class="filter-select" data-col="3">
                            <option value="">All Customer Groups</option>
                            {% for item in filter_header.customer_groups %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th>
                        <select class="filter-select" data-col="4">
                            <option value="">All Twines</option>
                            {% for item in filter_header.twine_codes %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th><input type="text" class="filter-input" placeholder="Mesh Start" data-col="5"></th>
                    <th><input type="text" class="filter-input" placeholder="Mesh End" data-col="6"></th>
                    <th><input type="text" class="filter-input" placeholder="Price" data-col="7"></th>
                    <td class="text-center">
                        <a class="btn btn-warning btn-xxs" id="clear-filters">Clear Filter</a>
                    </td>
                </tr>
            </thead>

            <tbody>
                {% for p in saved_prices %}
                <tr>
                    <td>{{ p.product }}</td>
                    <td>{{ p.sequence_id }}</td>
                    <td>{{ p.code }}</td>
                    <td>{{ p.customer_group }}</td>
                    <td>{{ p.twine_code }}</td>
                    <td>{{ p.mesh_size_start }}</td>
                    <td>{{ p.mesh_size_end }}</td>
                    <td>{{ p.price }}</td>
                  <td class="text-center">
                    <a href="javascript:void(0);" class="btn btn-primary btn-xxs load-price" data-price-code="{{ p.code }}">Load</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="9" class="text-center text-muted small">No saved records</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- EMPTY ROW TEMPLATE (HIDDEN) -->
<table style="display:none;">
    <tbody id="empty-row-template">
        <tr class="price-row">
            <td>
                <select name="form-__prefix__-product" class="form-control">
                    <option value="">Select Product</option>
                    {% for item in filter_header.product_names %}
                        <option value="{{ item }}">{{ item }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="number" name="form-__prefix__-sequence_id" class="form-control seq-field" value="1"></td>
            <td><input type="text" name="form-__prefix__-code" class="form-control"></td>
            <td><input type="text" name="form-__prefix__-customer_group" class="form-control"></td>
            <td><input type="text" name="form-__prefix__-twine_code" class="form-control"></td>
            <td><input type="text" name="form-__prefix__-mesh_size_start" class="form-control"></td>
            <td><input type="text" name="form-__prefix__-mesh_size_end" class="form-control"></td>
            <td><input type="text" name="form-__prefix__-price" class="form-control"></td>
            <td class="text-center">
                <button type="button" class="btn btn-warning btn-xxs clear-row">Clr</button>
                <button type="button" class="btn btn-danger btn-xxs delete-row">Del</button>
            </td>
        </tr>
    </tbody>
</table>

<script>
/* Show/hide price entry section */
document.getElementById("btn-new-price").addEventListener("click", () => {
    const box = document.getElementById("price-entry-area");
    box.style.display = (box.style.display === "none") ? "block" : "none";
});

/* ADD ROW LOGIC */
document.getElementById("add-item-price").addEventListener("click", () => {
    const tbody = document.getElementById("price-tbody");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");
    let total = parseInt(totalForms.value);

    /* CASE 0 — If initial hidden row exists → reveal it */
    const hiddenRow = tbody.querySelector("tr.price-row[style*='display:none']");
    if (hiddenRow) {
        hiddenRow.style.display = "";
        totalForms.value = 1;
        return;
    }

    /* CASE 1 — If no rows, use EMPTY ROW TEMPLATE */
    if (total === 0) {
        const template = document.getElementById("empty-row-template").querySelector("tr").outerHTML;
        tbody.insertAdjacentHTML("beforeend", template);
        const firstRow = tbody.querySelector("tr.price-row:last-of-type");
        firstRow.querySelector(".seq-field").value = 1;
        totalForms.value = 1;
        return;
    }

    /* CASE 2 — Clone last row */
    let lastRow = tbody.querySelector("tr.price-row:last-of-type");
    let newHTML = lastRow.outerHTML;

    newHTML = newHTML.replace(new RegExp(`form-${total - 1}`, "g"), `form-${total}`);
    newHTML = newHTML.replace(new RegExp(`id_form-${total - 1}`, "g"), `id_form-${total}`);

    tbody.insertAdjacentHTML("beforeend", newHTML);

    const newRow = tbody.querySelector("tr.price-row:last-of-type");
    const prevInputs = lastRow.querySelectorAll("input, select");
    const newInputs = newRow.querySelectorAll("input, select");

    /* Copy values except sequence_id and DELETE */
    newInputs.forEach((el, index) => {
        let prevEl = prevInputs[index];
        if (el.name.includes("sequence_id")) return;
        if (el.name.includes("DELETE")) return;
        el.value = prevEl.value;
    });

    /* Increment sequence_id */
    const seq = newRow.querySelector("input[name*='sequence_id'], .seq-field");
    if (seq) seq.value = total + 1;

    totalForms.value = total + 1;
});

/* DELETE ROW */
document.addEventListener("click", e => {
    if (e.target.classList.contains("delete-row")) {
        const row = e.target.closest("tr.price-row");
        const del = row.querySelector("input[name*='DELETE']");
        if (del) del.checked = true;  // keep for Django formset deletion
        row.remove(); // actually remove the row from DOM
    }
});

/* CLEAR ROW */
document.addEventListener("click", e => {
    if (e.target.classList.contains("clear-row")) {
        const row = e.target.closest("tr.price-row");
        row.querySelectorAll("input, select").forEach(el => {
            if (el.name.includes("sequence_id") || el.name.includes("DELETE")) return;
            el.value = "";
        });
    }
});

/* FILTER LOGIC */
function filterTable() {
    if (!table) return;
    const rows = table.querySelectorAll("tr");

    rows.forEach(row => {
        let show = true;

        filterInputs.forEach(input => {
            const colIndex = Number(input.dataset.col);
            const val = input.value.trim().toLowerCase();
            const cellVal = row.cells[colIndex].textContent.trim().toLowerCase();
            if (val && !cellVal.includes(val)) show = false;
        });

        filterSelects.forEach(select => {
            const val = select.value.trim().toLowerCase();
            const colIndex = Number(select.dataset.col);
            const cellVal = row.cells[colIndex].textContent.trim().toLowerCase();
            if (val && cellVal !== val) show = false;
        });

        row.style.display = show ? "" : "none";
    });
}

document.addEventListener("DOMContentLoaded", function() {
    filterInputs = document.querySelectorAll(".filter-input");
    filterSelects = document.querySelectorAll(".filter-select");
    table = document.querySelector(".table-striped.price-table tbody");

    filterInputs.forEach(input => input.addEventListener("keyup", filterTable));
    filterSelects.forEach(select => select.addEventListener("change", filterTable));

    document.getElementById("clear-filters").addEventListener("click", () => {
        filterInputs.forEach(input => input.value = "");
        filterSelects.forEach(select => select.selectedIndex = 0);
        filterTable();
    });
});

// document.addEventListener("click", function(e) {
//     if (!e.target.classList.contains("load-price")) return;

//     const savedRow = e.target.closest("tr");
//     const priceCode = savedRow.querySelector("td:nth-child(3)").textContent.trim();
//     const tbody = document.getElementById("price-tbody");
//     const totalForms = document.getElementById("id_form-TOTAL_FORMS");

//     // Clear existing rows
//     tbody.innerHTML = "";
//     let total = 0;

//     // Get all saved rows
//     const savedRows = document.querySelectorAll(".table-striped.price-table tbody tr");

//     savedRows.forEach(row => {
//         const code = row.querySelector("td:nth-child(3)").textContent.trim();
//         if (code === priceCode) {
//             // Use empty template
//             let template = document.getElementById("empty-row-template").querySelector("tr").outerHTML;

//             // Replace form index placeholders
//             template = template.replace(/form-0/g, `form-${total}`);
//             template = template.replace(/id_form-0/g, `id_form-${total}`);

//             tbody.insertAdjacentHTML("beforeend", template);
//             const newRow = tbody.querySelector("tr.price-row:last-of-type");

//             const cells = row.querySelectorAll("td");
//             const inputs = newRow.querySelectorAll("input, select");

//             inputs.forEach((el, idx) => {
//                 if (el.name.includes("sequence_id") || el.classList.contains("seq-field")) {
//                     el.value = total + 1; // increment sequence
//                 } else {
//                     el.value = cells[idx].textContent.trim() || "";
//                 }
//             });

//             total++;
//         }
//     });

//     totalForms.value = total; // update TOTAL_FORMS
//     document.getElementById("price-entry-area").style.display = "block";
// });

// document.addEventListener("click", function(e) {
//     if (!e.target.classList.contains("load-price")) return;

//     const priceCode = e.target.dataset.priceCode;

//     // Fetch all price rows from backend
//     fetch(`/invoice/price-list/load/${priceCode}/`)
//         .then(response => response.json())
//         .then(data => {
//             const tbody = document.getElementById("price-tbody");
//             const totalForms = document.getElementById("id_form-TOTAL_FORMS");

//             tbody.innerHTML = "";  // clear old rows
//             let total = 0;

//             data.items.forEach((item, idx) => {
//                 // Trigger row creation (your existing logic)
//                 document.getElementById("add-item-price").click();

//                 const row = tbody.querySelector("tr.price-row:last-of-type");
//                 const inputs = row.querySelectorAll("input, select");

//                 inputs.forEach(input => {
//                     if (input.name.includes("product"))
//                         input.value = item.product;

//                     else if (input.name.includes("sequence_id"))
//                         input.value = idx + 1;

//                     else if (input.name.includes("code"))
//                         input.value = item.code;

//                     else if (input.name.includes("customer_group"))
//                         input.value = item.customer_group;

//                     else if (input.name.includes("twine_code"))
//                         input.value = item.twine_code;

//                     else if (input.name.includes("mesh_size_start"))
//                         input.value = item.mesh_size_start;

//                     else if (input.name.includes("mesh_size_end"))
//                         input.value = item.mesh_size_end;

//                     else if (input.name.includes("price"))
//                         input.value = item.price;
//                 });

//                 total++;
//             });

//             totalForms.value = total;   // update formset count
//             document.getElementById("price-entry-area").style.display = "block";
//         })
//         .catch(err => console.error("Price Load Error:", err));
// });


document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("load-price")) return;

    const priceCode = e.target.dataset.priceCode;
    const tbody = document.getElementById("price-tbody");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    fetch(`/invoice/price-list/load/${priceCode}`)
        .then(res => res.json())
        .then(data => {
            tbody.innerHTML = "";   // clear old rows
            let total = 0;
            data.items.forEach((item, idx) => {
                // Create new row using template
                const template = document
                    .getElementById("empty-row-template")
                    .querySelector("tr")
                    .cloneNode(true);

                // update Django form index
                template.innerHTML = template.innerHTML
                    .replace(/form-0/g, `form-${idx}`)
                    .replace(/id_form-0/g, `id_form-${idx}`);

                const inputs = template.querySelectorAll("input, select");

                inputs.forEach(inp => {
                   
                    if (inp.name.includes("product"))
                        inp.value = item.product;
                    else if (inp.name.includes("sequence_id"))
                        inp.value = item.sequence_id;
                    else if (inp.name.includes("code"))
                        inp.value = item.code;
                    else if (inp.name.includes("customer_group"))
                        inp.value = item.customer_group;
                    else if (inp.name.includes("twine_code"))
                        inp.value = item.twine_code;
                    else if (inp.name.includes("mesh_size_start"))
                        inp.value = item.mesh_size_start;
                    else if (inp.name.includes("mesh_size_end"))
                        inp.value = item.mesh_size_end;
                    else if (inp.name.includes("price"))
                        inp.value = item.price;
                });

                tbody.appendChild(template);
                total++;
            });

            totalForms.value = total;
            document.getElementById("price-entry-area").style.display = "block";
        })
        .catch(err => {
            console.error("Price Load Error:", err);
            alert("Failed to load price details.");
        });
});


document.getElementById("delete-price-list").addEventListener("click", () => {
    const tbody = document.getElementById("price-tbody");
    tbody.innerHTML = "";
    document.getElementById("id_form-TOTAL_FORMS").value = 0;
});

</script>

{% endblock %}
