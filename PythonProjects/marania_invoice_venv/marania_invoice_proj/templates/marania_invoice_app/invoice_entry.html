{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block main %}

{% load dict_extras %}  <!-- load once at the top -->

<style>
.btn-3d-yellow {
  background: linear-gradient(to bottom, #ffeb3b, #f9c60a) !important;
  color: #212529 !important;
  border: 1px solid #e0b800 !important;
  border-radius: 6px !important;
  box-shadow: 0 4px 0 #caa600, 0 6px 12px rgba(0, 0, 0, 0.15) !important;
  font-weight: 500 !important;
  transition: all 0.15s ease-in-out;
  padding: 4px 10px !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-3d-yellow:hover {
  background: linear-gradient(to bottom, #ffe600, #f9b208) !important;
  transform: translateY(-2px);
  box-shadow: 0 6px 0 #caa600, 0 10px 16px rgba(0, 0, 0, 0.2) !important;
}

.btn-3d-yellow:active {
  background: linear-gradient(to bottom, #f9c60a, #d4a500) !important;
  transform: translateY(3px);
  box-shadow: 0 1px 0 #caa600 inset !important;
}
</style>

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="container my-5">

    <h2 class="mb-4">Invoice</h2>

    <!-- Button to open Add Invoice Form -->
    <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#customerForm" aria-expanded="false" aria-controls="customerForm">
      New Invoice
    </button>

    <!-- Collapsible Invoice Form -->
    <div class="collapse" id="customerForm">
      <!-- <div class="container border rounded p-4 mb-4 shadow-sm"> -->
        <form method="POST" action="{% url 'invoice_save' %}">
          {% csrf_token %}

          <!-- Customer Group -->
          <!-- <div class="group-box p-2 border rounded mb-3"> -->
            <div class="card shadow-sm p-3">

              <!-- Row 1: Date & Invoice Number -->
              <div class="row mb-3">
                <div class="col-md-4">{{ invoice_form.invoice_date }}</div>
                <div class="col-md-8">{{ invoice_form.invoice_number }}</div>
              </div>

              <!-- Row 2: Customer Code, Name, GST -->
              <div class="row mb-3">
                <div class="col-md-3">
                  {{ invoice_form.customer_code }}
                    <!-- The datalist options -->
                      <datalist id="customer_code_list">
                          {% for customer in customers %}
                              <option value="{{ customer.code }}-{{ customer.name }}"></option>
                          {% endfor %}
                      </datalist>
                </div>

                <div class="col-md-6">
                  {{ invoice_form.customer_name }}
                  <!-- The datalist options -->
                      <datalist id="customer_name_list">
                          {% for customer in customers %}
                              <option value="{{ customer.name }}"></option>
                          {% endfor %}
                      </datalist>
                </div>

                <div class="col-md-3">{{ invoice_form.customer_gst }}</div>
              </div>
        
            <!-- Row 3: Customer contact, email and address -->
            <div class="row mb-3 d-flex align-items-stretch">
                <!-- Left column: contact and email stacked -->
                <div class="col-md-6 d-flex flex-column">
                    <div class="mb-2">{{ invoice_form.customer_contact }}</div>
                    <div class="mb-2">{{ invoice_form.customer_email }}</div>
                </div>

                <!-- Right column: address, stretches to match left column height -->
                <div class="col-md-6 h-100">
                    {{ invoice_form.customer_address }}
                </div>
            </div>


              <!--  Row 4-->
              <div class="row mb-3">
                <div class="col-md-3">
                  {{ invoice_form.ship_to_customer_code }}
                    <!-- The datalist options -->
                      <datalist id="ship_to_customer_code_list">
                          {% for customer in customers %}
                              <option value="{{ customer.code }}-{{ customer.name }}"></option>
                          {% endfor %}
                      </datalist>
                </div>

                <div class="col-md-6">
                  {{ invoice_form.ship_to_customer_name }}
                  <!-- The datalist options -->
                      <datalist id="ship_to_customer_name_list">
                          {% for customer in customers %}
                              <option value="{{ customer.name }}"></option>
                          {% endfor %}
                      </datalist>
                </div>

                <div class="col-md-3">{{ invoice_form.ship_to_customer_gst }}</div>
              </div>
        
            <!-- Row 5: Customer contact, email and address -->
            <div class="row mb-3 d-flex align-items-stretch">
                <!-- Left column: contact and email stacked -->
                <div class="col-md-6 d-flex flex-column">
                    <div class="mb-2">{{ invoice_form.ship_to_customer_contact }}</div>
                    <div class="mb-2">{{ invoice_form.ship_to_customer_email }}</div>
                </div>

                <!-- Right column: address, stretches to match left column height -->
                <div class="col-md-6 h-100">
                    {{ invoice_form.ship_to_customer_address }}
                </div>
            </div>



              <!-- Row 6: Dispatched Through -->
               <div class="row mb-3">
                <div class="col-md-12">
                  {{ invoice_form.dispatched_through }}
                  <datalist id="dispatched_through_list"></datalist>
                </div>
                </div>



              <!-- Invoice Items Group -->
              <div class="group-box mb-3">
                <div class="group-title">INVOICE ITEMS</div>
                <div id="item-container"></div>
                <button type="button" id="add-item" class="btn btn-secondary btn-sm mt-2">+ Add Another Item</button>
              </div>

              <!-- Submit & Reset -->
              <div class="text-center">
                <button type="submit" class="btn btn-success me-2">Submit Invoice</button>
                <button type="button" class="btn btn-info me-2" onclick="showGSTCalculator()">GST Calculator</button>
                <button type="button" class="btn btn-info me-2" onclick="showPriceList()">Price List</button>
                <button type="reset" class="btn btn-secondary">Clear Invoice</button>
              </div>

            </div> <!-- card -->
          <!-- </div> group-box -->
        </form>
      <!-- </div> container collapse -->
    </div> <!-- collapse -->

    <!-- Invoice List (outside collapse) -->
    <div class="invoice-list mt-4">
      {% if invoices %}
        <div class="table-responsive">
          <table class="table table-striped table-hover table-bordered table-sm align-middle">
            <thead class="table-dark">
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Invoice #</th>
                <th scope="col">Customer</th>
                <th scope="col">Weight</th>
                <th scope="col">Sub Total</th>
                <th scope="col">Invoice Amount</th>
                <th scope="col">View Invoice</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
                <tr>
                  <td>{{ invoice.invoice_date|date:"Y-m-d" }}</td>
                  <td>{{ invoice.invoice_number }}</td>
                  <td>{{ invoice.customer_name }}</td>
                  {% with invoice_item=invoiceitems|get_item:invoice.invoice_number %}
                    <td>
                      {% if invoice_item %}
                        {{ invoice_item.weight }}
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                     <td>
                      {% if invoice_item %}
                        {{ invoice_item.sub_total }}
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                     <td>
                      {% if invoice_item %}
                        {{ invoice_item.invoice_amount }}
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                  {% endwith %} 
                  <!-- ðŸŒˆ Attractive View Button -->

                  <td>
                    <a href="javascript:void(0);" 
                      onclick="openInvoicePopup('{{ invoice.invoice_number }}')" 
                      class="btn btn-sm btn-secondary d-inline-flex align-items-center">
                      <i class="bi bi-eye me-1"></i> View
                    </a>
                  
                 <a href="{% url 'invoice_pdf' invoice.invoice_number %}" 
                    class="btn btn-sm btn-secondary d-inline-flex align-items-center">
                    <i class="bi bi-eye me-1"></i> PDF
                  </a>

                     <a href="javascript:void(0);" 
                      onclick="openInvoicePopup('{{ invoice.invoice_number }}')" 
                      class="btn btn-sm btn-secondary d-inline-flex align-items-center">
                      <i class="bi bi-eye me-1"></i> Excel
                    </a>
                  </td>
                   

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">No invoices found.</p>
      {% endif %}
    </div> <!-- invoice-list -->

  </div> <!-- container -->
</main>

<!-- Safely embed the dictionary -->
<!-- {{ customer_dict|json_script:"customer-data" }} -->

<!-- JS Section -->
<script>

function showGSTCalculator() {
    // Your tax calculation logic here    
    const url = `/invoice/invoice_entry/show_gst_calculator`;
    window.open(url, 'CalculatorPopup', 'width=1000,height=750,top=100,left=200,resizable=yes,scrollbars=yes');
    
}

function showPriceList() {
    // Your tax calculation logic here
    alert("Price List!");
}

const customerData = JSON.parse('{{ customer_dict|escapejs }}');
document.addEventListener('DOMContentLoaded', function() {
    // Find the input field connected to your datalist
    const input = document.querySelector('input[list="customer_code_list"]');
    const datalist = document.getElementById('customer_code_list');

    if (input && datalist) {
        input.addEventListener('input', function() {
            const val = input.value;
            const option = Array.from(datalist.options).find(o => o.value === val);

            if (option) {
                // If user selected a full "CODE-NAME" entry,
                // trim it down to show only the CODE part.
                const codeOnly = val.split('-')[0].trim();
                input.value = codeOnly;
            }
        });
    }

    // Ship to Customer Code 
    const ship_to_input = document.querySelector('input[list="ship_to_customer_code_list"]');
    const ship_to_datalist = document.getElementById('ship_to_customer_code_list');
    if (ship_to_input && ship_to_datalist) {
      ship_to_input.addEventListener('input', function() {
                  const val = ship_to_input.value;
                  const option = Array.from(ship_to_datalist.options).find(o => o.value === val);

                  if (option) {
                      // If user selected a full "CODE-NAME" entry,
                      // trim it down to show only the CODE part.
                      const codeOnly = val.split('-')[0].trim();
                      ship_to_input.value = codeOnly;
                  }
              });
    }

});

  function openInvoicePopup(invoiceNumber) {
  const url = `/invoice/invoice_entry/view/${invoiceNumber}`;
  window.open(url, 'InvoicePopup', 'width=1000,height=750,top=100,left=200,resizable=yes,scrollbars=yes');
}

  const ship_to_customerCodeInput = document.querySelector('input[name="ship_to_customer_code"]');
  ship_to_customerCodeInput.addEventListener('blur', function() {
     const code = this.value.toUpperCase().trim();
    if (!code) { alert("Ship to Customer code cannot be empty!"); return; }
     document.querySelector('input[name="ship_to_customer_name"]').value = customerData[code].name;
      document.querySelector('input[name="ship_to_customer_gst"]').value = customerData[code].gst;
      document.querySelector('textarea[name="ship_to_customer_address"]').value = customerData[code].address_bill_to;
      document.querySelector('input[name="ship_to_customer_contact"]').value = customerData[code].phone;
      document.querySelector('input[name="ship_to_customer_email"]').value = customerData[code].email;

  });

  const customerCodeInput = document.querySelector('input[name="customer_code"]');
  customerCodeInput.addEventListener('blur', function() {
    const code = this.value.toUpperCase().trim();
    if (!code) { alert("Customer code cannot be empty!"); return; }

     // Read and parse it back into a JavaScript object
    //const customerData = JSON.parse('{{ customer_dict|escapejs }}');
    if (customerData[code]) {
      //Bill to customer
      document.querySelector('input[name="customer_name"]').value = customerData[code].name;
      document.querySelector('input[name="customer_gst"]').value = customerData[code].gst;
      document.querySelector('textarea[name="customer_address"]').value = customerData[code].address_bill_to;
      document.querySelector('input[name="customer_contact"]').value = customerData[code].phone;
      document.querySelector('input[name="customer_email"]').value = customerData[code].email;

      //Ship to customer  
      document.querySelector('input[name="ship_to_customer_code"]').value = code;//customerData[code].code;
      document.querySelector('input[name="ship_to_customer_name"]').value = customerData[code].name;
      document.querySelector('input[name="ship_to_customer_gst"]').value = customerData[code].gst;
      document.querySelector('textarea[name="ship_to_customer_address"]').value = customerData[code].address_bill_to;
      document.querySelector('input[name="ship_to_customer_contact"]').value = customerData[code].phone;
      document.querySelector('input[name="ship_to_customer_email"]').value = customerData[code].email;

      //document.querySelector('textarea[name="ship_to_customer_address"]').value = customerData[code].address_ship_to;

      // populate dispatched through control 
      const transporter_dict = JSON.parse('{{ transporter_dict|escapejs }}');
      const dispatched_through = document.getElementById('dispatched_through');
      const datalist = document.getElementById('dispatched_through_list');

      datalist.innerHTML = '';
      let defaultValue = '';
      if (transporter_dict[code]) {
        currentIndex = -1 ;
        defaultIndex = -1;
        transporter_dict[code].forEach(item => {
        currentIndex = currentIndex + 1;
        const option = document.createElement('option');
        option.value = `${item.transporter_name} ( ${item.delivery_place} ) ` ; //item.transporter_name;

        datalist.appendChild(option);
        if ( item.is_default_transport ) {
               defaultValue = option.value;
        }
      });
      document.querySelector('input[name="dispatched_through"]').value = defaultValue;
      }

    }
  });




  // Invoice Items JS
  let rowIndex = -1;
  const container = document.getElementById('item-container');
  document.getElementById('add-item').addEventListener('click', function() {
    rowIndex++;
    const row = document.createElement('div');
    row.classList.add('item-row', 'row', 'mb-3');
    row.dataset.index = rowIndex;

    row.innerHTML = `
      <div class="d-flex align-items-center flex-wrap gap-1 w-100">
        <div class="d-flex align-items-center" style="flex:1.6;position:relative;">
          <input type="text" name="item_spec[]" class="form-control form-control-sm item-spec" placeholder="Specification">
          <small class="text-success ms-1 spec-message" style="display:none;">âœ“ Spec entered</small>
        </div>
        <input type="text" name="item_code[]" class="form-control form-control-sm" placeholder="Code" style="flex:0.3;">
        <input type="text" name="item_description[]" class="form-control form-control-sm" placeholder="Description" style="flex:1.5;">
        <input type="text" name="item_mesh_size[]" class="form-control form-control-sm" placeholder="MM" style="flex:0.3;">
        <input type="text" name="item_mesh_depth[]" class="form-control form-control-sm" placeholder="MD" style="flex:0.3;">
        <input type="number" name="item_quantity[]" class="form-control form-control-sm" placeholder="Qty" style="flex:0.4;">
        <input type="number" name="item_price[]" step="1" class="form-control form-control-sm" placeholder="Q.Price" style="flex:0.4;">
        <div class="d-flex gap-1" style="flex:1.5;">
          <input type="text" name="item_gst[]" class="form-control form-control-sm" placeholder="GST">
          <input type="text" name="item_final_price[]" class="form-control form-control-sm" placeholder="Price+GST" style="width:90px;">
          <input type="text" name="item_hsn[]" class="form-control form-control-sm" placeholder="HSN">
        </div>
        <div class="d-flex gap-1 justify-content-center" style="flex:0.4;">
          <button type="button" class="btn btn-outline-secondary btn-sm clear-item">Clear</button>
          <button type="button" class="btn btn-outline-danger btn-sm delete-item">Del</button>
        </div>
      </div>
    `;

      // Enable lost focus event
  row.querySelector('.item-spec').addEventListener('blur', function () {
    
    const index = row.dataset.index;  // reads data-index
    console.log("Current index:", index)
    const message = this.parentElement.querySelector('.spec-message');
    current_item_spec = document.getElementsByName('item_spec[]')[index].value;

      // Split the string by '/'
    const parts = current_item_spec.split('/');

    quantity = 0;
    price = 0; 
    gst_percentage = 5/100;
    gst_amount = 0
    total_amount = 0
    if (parts.length >= 5){
      if ( (parts.length == 5) && (parts[0].startsWith("DK16") || parts[0].startsWith("DK20")))
      {
         document.getElementsByName('item_description[]')[index].value = "Mono Filament Fishnet"; 
      }
      else if (parts[0].startsWith("DK16") || parts[0].startsWith("DK20")) {
              document.getElementsByName('item_description[]')[index].value = "Mono Filament Fishnet ( " + parts[5] + " )";
          }  
    }

    if (parts.length >= 4){
      document.getElementsByName('item_price[]')[index].value =  parts[4] ;
      price = parts[4] ;
    }

    if (parts.length >= 3){
     document.getElementsByName('item_quantity[]')[index].value = parts[3];
     quantity = parts[3];
    }

    if (parts.length >= 2){
      document.getElementsByName('item_mesh_depth[]')[index].value = parts[2];
    }
     
    if (parts.length >= 1){
      document.getElementsByName('item_mesh_size[]')[index].value = parts[1];
    }

    if (parts.length >= 0){
      document.getElementsByName('item_code[]')[index].value = parts[0];
    }

    // read price details 
    if (document.getElementsByName('item_code[]')[index].value != "")
    {
      const price_dict = JSON.parse('{{ price_dict|escapejs }}');
      const customerCodeInput = document.querySelector('input[name="customer_code"]').value;
      const item_code = document.getElementsByName('item_code[]')[index].value;
      const customerData = JSON.parse('{{ customer_dict|escapejs }}');

      customerdata = customerData[customerCodeInput];
      
      console.log("item code is not empty.." + customerCodeInput);
      console.log("item code" + item_code);
      console.log("price_dict" + price_dict);

      if (price_dict[item_code] &&  parts[4] == "")
      {
        // console.log("price dict has value fro the code");
        // console.log("price dict for the item code : "+price_dict[item_code])
        // console.log("customer data: "+JSON.stringify(customerdata.price_list_tag))
        // console.log("price list tag : "+JSON.stringify(price_dict[item_code][customerdata.price_list_tag]))

          if (price_dict[item_code][customerdata.price_list_tag]){
            const mesh_size = Number(document.getElementsByName('item_mesh_size[]')[index].value);
            customer_price_dict = price_dict[item_code][customerdata.price_list_tag];
            
            console.log("customer_price_dict Data:", JSON.stringify(customer_price_dict));
            customer_price_dict.forEach(item => {
              // Each item is an object with a single key
              const key = Object.keys(item)[0];   // e.g. "15-16"
              const value = Object.values(item)[0]; // e.g. "810.00"

              // Split the key if needed
              const parts = key.split("-"); // ["15", "16"]
              const start = Number(parts[0]);
              const end = parts[1] == '999' ? Infinity: Number(parts[1]); 
              //Number(parts[1]);
              const product_price = Number(value);
              if ( mesh_size >= start && (mesh_size <= end) ) {
                price = product_price; 
                document.getElementsByName('item_price[]')[index].value = price;
                console.log(`configured price selected : ${price}`);
              }
              else{
                console.log(`price not configured for this item.`);
              }

              //console.log(`Start: ${start}, End: ${end}, Price: ${price}`);
          });
           
          }
      }
      

    }
    
    gst_amount = (quantity * price ) * gst_percentage;
    total_amount = (quantity * price ) + gst_amount;
    console.log(`Price: ${price}`);
    document.getElementsByName('item_gst[]')[index].value = gst_amount;
    document.getElementsByName('item_final_price[]')[index].value = total_amount;
    document.getElementsByName('item_hsn[]')[index].value = "5808";

})

    container.appendChild(row);
  });

 

  container.addEventListener('click', function(e){
    if(e.target.classList.contains('delete-item')){
      e.target.closest('.item-row').remove();
    } else if(e.target.classList.contains('clear-item')){
      e.target.closest('.item-row').querySelectorAll('input').forEach(inp=>inp.value='');
    }
  });
</script>


{% endblock %}