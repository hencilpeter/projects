{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}


{% block main %}

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  
  <div class="container my-5">
  <h2 class="mb-4">Customers</h2>

  <!-- Button to open Add Customer Form -->
  <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#customerForm" aria-expanded="false">
    Add Customer
  </button>

  <!-- Add/Edit Customer Form -->
  <div class="collapse" id="customerForm">
    <div class="card card-body mb-4">

     <form method="POST"  action="{% url 'create_customer' %}">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-3">
            {{ form.code.label_tag }}
            {{ form.code }}
            {{ form.code.errors }}
          </div>
          <div class="col-md-4">
            {{ form.name.label_tag }}
            {{ form.name }}
            {{ form.name.errors }}
          </div>
          <div class="col-md-3">
            {{ form.gst.label_tag }}
            {{ form.gst }}
            {{ form.gst.errors }}
          </div>
          <div class="col-md-3">
            {{ form.phone.label_tag }}
            {{ form.phone }}
            {{ form.phone.errors }}
          </div>
          <div class="col-md-4">
            {{ form.email.label_tag }}
            {{ form.email }}
            {{ form.email.errors }}
          </div>
          <div class="col-md-6">
            {{ form.address_bill_to.label_tag }}
            {{ form.address_bill_to }}
            {{ form.address_bill_to.errors }}
          </div>
          <div class="col-md-6">
            {{ form.address_ship_to.label_tag }}
            {{ form.address_ship_to }}
            {{ form.address_ship_to.errors }}
          </div>
          <div class="col-md-3">
            {{ form.is_within_state.label_tag }}
            {{ form.is_within_state }}
            {{ form.is_within_state.errors }}
          </div>
          <div class="col-md-3">
            {{ form.price_list_tag.label_tag }}
            {{ form.price_list_tag }}
            {{ form.price_list_tag.errors }}
          </div>
          <!-- <div class="col-md-3">
            {{ form.default_delivery_transport.label_tag }}
            {{ form.default_delivery_transport }}
            {{ form.default_delivery_transport.errors }}
          </div>
          <div class="col-md-3">
            {{ form.default_delivery_location.label_tag }}
            {{ form.default_delivery_location }}
            {{ form.default_delivery_location.errors }}
          </div> -->


          
      </div>

      <!-- Transportation Group -->
      <div class="group-box mb-3">
        <div class="group-title">Transportation Details</div>
        <div id="item-container"></div>
        <button type="button" id="add-item" class="btn btn-secondary btn-sm mt-2">+ Add Transport Details</button>
      </div>

        <button type="submit" class="btn btn-success mt-3">Save Customer</button>
      </form>
    </div>
  </div>

  <!-- Customer List Table -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>GST</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Bill To</th>
          <th>Ship To</th>
          <th>Within State</th>
          <th>Price List</th>
          <!-- <th>Transport</th>
          <th>Delivery Location</th> -->
          <th>Created</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody>
        {% for customer in customers %}
        <tr>
          <td>{{ customer.code }}</td>
          <td>{{ customer.name }}</td>
          <td>{{ customer.gst }}</td>
          <td>{{ customer.phone }}</td>
          <td>{{ customer.email }}</td>
          <td>{{ customer.address_bill_to }}</td>
          <td>{{ customer.address_ship_to }}</td>
          <td>{{ customer.is_within_state|yesno:"Yes,No" }}</td>
          <td>{{ customer.price_list_tag }}</td>
          <!-- <td>{{ customer.default_delivery_transport }}</td>
          <td>{{ customer.default_delivery_location }}</td> -->
          <td>{{ customer.created_at|date:"Y-m-d H:i" }}</td>
          <td>{{ customer.updated_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="13" class="text-center">No customers found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

 </main> 

 <script>
  let rowIndex = -1;
  const container = document.getElementById('item-container');
  document.getElementById('add-item').addEventListener('click', function() {
    rowIndex++;
    const row = document.createElement('div');
    row.classList.add('item-row', 'row', 'mb-3');
    row.dataset.index = rowIndex;

    row.innerHTML = `
    <div class="d-flex align-items-center flex-wrap gap-2 w-100">
  
  <!-- Input fields: each takes equal space -->
  <div class="d-flex gap-2 flex-fill">
    <div class="flex-fill">
      <input type="text" name="delivery_place[]" class="form-control form-control-sm" placeholder="Delivery Place">
    </div>
    
    <div class="flex-fill">
      <input type="text" name="transport_gst[]" class="form-control form-control-sm" placeholder="Transporter Name">
    </div>

    <div class="flex-fill">
      <input type="text" name="transport_gst[]" class="form-control form-control-sm" placeholder="Transporter GST">
    </div>

    <div class="flex-fill">
      <input type="text" name="vehicle_name_number[]" class="form-control form-control-sm" placeholder="Vehicle Name & Number">
    </div>
    

    <!-- Default transport radio button with label -->
    <div class="flex-fill d-flex align-items-center justify-content-center">
      <label class="mb-0">
        <input type="radio" name="default_transport" class="form-check-input me-1">
        Default Transport
      </label>
    </div>
  </div>

  <!-- Buttons: aligned next to inputs -->
  <div class="d-flex gap-2 ms-2">
    <button type="button" class="btn btn-outline-secondary btn-sm clear-item">Clear</button>
    <button type="button" class="btn btn-outline-danger btn-sm delete-item">Del</button>
  </div>

</div>

    `;

    document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('transport-container');
  const addButton = document.getElementById('add-transport');
  const template = document.getElementById('transport-template').content;

  // Add new transport row
  addButton.addEventListener('click', function() {
    const clone = document.importNode(template, true);
    container.appendChild(clone);

    const newRow = container.lastElementChild;
  });

});


 container.addEventListener('click', function(e){
    if(e.target.classList.contains('delete-item')){
      e.target.closest('.item-row').remove();
    } else if(e.target.classList.contains('clear-item')){

      //e.target.closest('.item-row').querySelectorAll('input').forEach(inp=>inp.value='');
      const row = e.target.closest('.item-row');
      row.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'radio') {
        inp.checked = false;   // Clear radio button
      } else {
      inp.value = '';        // Clear text input
      }
  });

    }
  });


//       // Enable lost focus event
//   row.querySelector('.item-spec').addEventListener('blur', function () {
//     const index = row.dataset.index;  // reads data-index
//     console.log("Current index:", index)
//     const message = this.parentElement.querySelector('.spec-message');
//       current_item_spec = document.getElementsByName('item_spec[]')[index].value;

//       // Split the string by '/'
//     const parts = current_item_spec.split('/');

//     quantity = 0;
//     price = 0; 
//     gst_percentage = 5/100;
//     gst_amount = 0
//     total_amount = 0
//     if (parts.length >= 5){
//       if ( (parts.length == 5) && (parts[0].startsWith("DK16") || parts[0].startsWith("DK20")))
//       {
//          document.getElementsByName('item_description[]')[index].value = "Mono Filament Fishnet"; 
//       }
//       else if (parts[0].startsWith("DK16") || parts[0].startsWith("DK20")) {
//               document.getElementsByName('item_description[]')[index].value = "Mono Filament Fishnet ( " + parts[5] + " )";
//           }  
//     }

//     if (parts.length >= 4){
//       document.getElementsByName('item_price[]')[index].value =  parts[4] ;
//       price = parts[4] ;
//     }

//     if (parts.length >= 3){
//      document.getElementsByName('item_quantity[]')[index].value = parts[3];
//      quantity = parts[3];
//     }

//     if (parts.length >= 2){
//       document.getElementsByName('item_mesh_depth[]')[index].value = parts[2];
//     }
     
//     if (parts.length >= 1){
//       document.getElementsByName('item_mesh_size[]')[index].value = parts[1];
//     }

//     if (parts.length >= 0){
//       document.getElementsByName('item_code[]')[index].value = parts[0];
//     }

//     gst_amount = (quantity * price ) * gst_percentage;
//     total_amount = (quantity * price ) + gst_amount
//     document.getElementsByName('item_gst[]')[index].value = gst_amount;
//     document.getElementsByName('item_final_price[]')[index].value = total_amount;
//     document.getElementsByName('item_hsn[]')[index].value = "5808";

// })

    container.appendChild(row);
  });
 </script>
{% endblock %}