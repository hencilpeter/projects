{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block main %}

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  
  <div class="container my-5">
  <h2 class="mb-4">Customers</h2>

  <!-- Button to open Add Customer Form -->
  <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#customerForm" aria-expanded="false">
    Add Customer
  </button>

  <!-- Add/Edit Customer Form -->
  <div class="collapse" id="customerForm">
    <div class="card card-body mb-4">

     <form method="POST" action="{% url 'create_customer' %}">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-3">
            {{ form.code.label_tag }}
            {{ form.code }}
            {{ form.code.errors }}
          </div>
          <div class="col-md-4">
            {{ form.name.label_tag }}
            {{ form.name }}
            {{ form.name.errors }}
          </div>
          <div class="col-md-3">
            {{ form.gst.label_tag }}
            {{ form.gst }}
            {{ form.gst.errors }}
          </div>
          <div class="col-md-3">
            {{ form.phone.label_tag }}
            {{ form.phone }}
            {{ form.phone.errors }}
          </div>
          <div class="col-md-4">
            {{ form.email.label_tag }}
            {{ form.email }}
            {{ form.email.errors }}
          </div>
           <div class="col-md-3">
            {{ form.is_within_state.label_tag }}
            {{ form.is_within_state }}
            {{ form.is_within_state.errors }}
          </div>
          <div class="row g-3">
          <!-- Billing Address -->
          <div class="col-md-4">
            {{ form.address_bill_to.label_tag }}
            {{ form.address_bill_to }}
            {{ form.address_bill_to.errors }}
          </div>

          <!-- Shipping Address -->
          <div class="col-md-4">
            {{ form.address_ship_to.label_tag }}
            {{ form.address_ship_to }}
            {{ form.address_ship_to.errors }}
          </div>

          <!-- Party Roles -->
          <div class="col-md-4">
            <label class="form-label">Party Roles</label>
            <div class="form-check">
              {% for role in form.partyroles.field.queryset %}
                <div class="form-check">
                  <input type="checkbox" name="partyroles" value="{{ role.id }}" class="form-check-input" id="role_{{ role.id }}"
                  {% if role in form.instance.partyroles.all %}checked{% endif %}>
                  <label class="form-check-label" for="role_{{ role.id }}">{{ role.role }}</label>
                </div>
              {% endfor %}
            </div>
            {{ form.partyroles.errors }}
          </div>
        </div>
        
        </div>  

        
        <!-- Transportation Group -->
        <div class="group-box mb-3">
          <div class="group-title">Transportation Details</div>
          <div id="item-container"></div>
          <button type="button" id="add-item" class="btn btn-secondary btn-sm mt-2">+ Add Transport Details</button>
        </div>

        <button type="submit" class="btn btn-success mt-3">Save Customer</button>
      </form>
    </div>
  </div>

  <!-- Customer List Table -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>GST</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Bill To</th>
          <th>Ship To</th>
          <th>Within State</th>
          <th>Price List</th>
          <th>Created</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody>
        {% for customer in customers %}
        <tr>
          <td>{{ customer.code }}</td>
          <td>{{ customer.name }}</td>
          <td>{{ customer.gst }}</td>
          <td>{{ customer.phone }}</td>
          <td>{{ customer.email }}</td>
          <td>{{ customer.address_bill_to }}</td>
          <td>{{ customer.address_ship_to }}</td>
          <td>{{ customer.is_within_state|yesno:"Yes,No" }}</td>
          <td>{{ customer.price_list_tag }}</td>
          <td>{{ customer.created_at|date:"Y-m-d H:i" }}</td>
          <td>{{ customer.updated_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="13" class="text-center">No customers found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

</main>

<script>
  let rowIndex = -1;

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('default-transport-checkbox')) {
      const row = e.target.closest('.transport-row');
      const hiddenInput = row.querySelector('.default-transport-hidden');
      hiddenInput.value = e.target.checked ? '1' : '1';
    }
  });

  const container = document.getElementById('item-container');
  document.getElementById('add-item').addEventListener('click', function() {
    rowIndex++;
    const row = document.createElement('div');
    row.classList.add('item-row', 'row', 'mb-3');
    row.dataset.index = rowIndex;

    row.innerHTML = `
      <div class="d-flex align-items-center flex-wrap gap-2 w-100">
        <div class="d-flex gap-2 flex-fill">
          <div class="flex-fill">
            <input type="text" name="delivery_place[]" class="form-control form-control-sm" placeholder="Delivery Place">
          </div>
          <div class="flex-fill">
            <input type="text" name="transporter_name[]" class="form-control form-control-sm" placeholder="Transporter Name">
          </div>
          <div class="flex-fill">
            <input type="text" name="transporter_gst[]" class="form-control form-control-sm" placeholder="Transporter GST">
          </div>
          <div class="flex-fill">
            <input type="text" name="vehicle_name_number[]" class="form-control form-control-sm" placeholder="Vehicle Name & Number">
          </div>
          <div class="d-flex align-items-center">
            <label class="mb-0">
              <input type="radio" name="default_transport" value="${rowIndex}" class="form-check-input">
              Default Transport
            </label>
          </div>
        </div>
        <div class="d-flex gap-2 ms-2">
          <button type="button" class="btn btn-outline-secondary btn-sm clear-item">Clear</button>
          <button type="button" class="btn btn-outline-danger btn-sm delete-item">Del</button>
        </div>
      </div>
    `;

    container.addEventListener('click', function(e){
      if(e.target.classList.contains('delete-item')){
        e.target.closest('.item-row').remove();
      } else if(e.target.classList.contains('clear-item')){
        const row = e.target.closest('.item-row');
        row.querySelectorAll('input').forEach(inp => {
          if (inp.type === 'radio') {
            inp.checked = false;
          } else {
            inp.value = '';
          }
        });
      }
    });

    container.appendChild(row);
  });
</script>

{% endblock %}
