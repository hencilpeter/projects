{% extends 'partials/base.html' %}
{% block main %}

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">Customer Price Dictionary</h3>
      <button type="button" id="clear-filters" class="btn btn-warning btn-sm">
        Clear Filters
      </button>
    </div>

    {% if rows %}
    <div class="table-responsive">
      <table class="table table-bordered table-striped table-sm" id="price-table">
        <thead class="table-dark">

          <!-- HEADER ROW -->
          <tr>
            <th>Customer Code</th>
            <th>Customer Name</th>
            <th>Customer Group</th>
            <th>Product Code</th>
            <th>Price Code</th>
            <th>Sequence ID</th>
            <th>Size Range</th>
            <th>Price</th>
            <th>Colour Extra Price</th>
            <th>Small Mesh Extra Price</th>
            <th>GST Included</th>
          </tr>

          <!-- FILTER ROW -->
          <tr class="table-secondary">
            <th><select class="form-select form-select-sm column-filter" data-col="0"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="1"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="2"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="3"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="4"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="5"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="6"><option value="">All</option></select></th>
            <th><input type="text" class="form-control form-control-sm column-filter" data-col="7" placeholder="Search price"></th>
            <th><select class="form-select form-select-sm column-filter" data-col="8"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="9"><option value="">All</option></select></th>
            <th><select class="form-select form-select-sm column-filter" data-col="10"><option value="">All</option></select></th>
          </tr>

        </thead>

        <tbody>
          {% for row in rows %}
          <tr>
            <td>{{ row.customer_code }}</td>
            <td>{{ row.customer_name }}</td>
            <td>{{ row.customer_group }}</td>
            <td>{{ row.product }}</td>
            <td>{{ row.price_code }}</td>
            <td>{{ row.sequence_id }}</td>
            <td>{{ row.size_range }}</td>
            <td>{{ row.price }}</td>
            <td>{{ row.colour_extra_price }}</td>
            <td>{{ row.small_mesh_size_extra_price }}</td>
            <td>{{ row.gst_included }}</td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
    {% else %}
      <p class="text-muted">No price data available.</p>
    {% endif %}

  </div>
</main>

<!-- FILTER SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const table = document.getElementById("price-table");
  const filters = document.querySelectorAll(".column-filter");
  const rows = table.querySelectorAll("tbody tr");

  // Populate select filters
  filters.forEach(filter => {
    if (filter.tagName === "SELECT") {
      const colIndex = filter.dataset.col;
      const values = new Set();

      rows.forEach(row => {
        values.add(row.children[colIndex].textContent.trim());
      });

      Array.from(values).sort().forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        filter.appendChild(option);
      });
    }
  });

  // Add filter event listeners
  filters.forEach(filter => {
    filter.addEventListener("input", applyFilters);
    filter.addEventListener("change", applyFilters);
  });

  function applyFilters() {
    rows.forEach(row => {
      let visible = true;

      filters.forEach(filter => {
        const colIndex = filter.dataset.col;
        const filterValue = filter.value.toLowerCase().trim();
        const cellText = row.children[colIndex].textContent.toLowerCase().trim();

        if (filterValue !== "") {
          if (filter.tagName === "SELECT") {
            if (cellText !== filterValue) visible = false;
          } else {
            if (!cellText.includes(filterValue)) visible = false;
          }
        }
      });

      row.style.display = visible ? "" : "none";
    });
  }

  // Clear filters button
  document.getElementById("clear-filters").addEventListener("click", function () {
    filters.forEach(filter => filter.value = "");
    rows.forEach(row => row.style.display = "");
  });

});
</script>

{% endblock %}
