{% extends 'partials/base.html' %}
{% load static %}

{% block main %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="container my-4">

    <h3>Product Master</h3>

    <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#productForm">
      Manage Products
    </button>

    <div class="collapse" id="productForm">
      <form method="POST">
        {% csrf_token %}
        <div class="card p-4 mb-4 shadow-sm">

          <div id="product-rows">
            <!-- ROW TEMPLATE -->
            <div class="row mb-2 product-row align-items-center">

              <div class="col-md-2">
                <input type="text" name="code" class="form-control form-control-sm" placeholder="Code">
              </div>

              <div class="col-md-2">
                <input type="text" name="name" class="form-control form-control-sm" placeholder="Name">
              </div>

              <div class="col-md-2">
                <input type="text" name="display_name" class="form-control form-control-sm" placeholder="Display Name">
              </div>

              <div class="col-md-1">
                <input type="text" name="hsn" class="form-control form-control-sm" placeholder="HSN">
              </div>

              <div class="col-md-1">
                <input type="number" step="0.01" name="cgst" class="form-control form-control-sm" placeholder="CGST">
              </div>

              <div class="col-md-1">
                <input type="number" step="0.01" name="sgst" class="form-control form-control-sm" placeholder="SGST">
              </div>

              <div class="col-md-1">
                <input type="number" step="0.01" name="igst" class="form-control form-control-sm" placeholder="IGST">
              </div>

              <div class="col-md-1">
                <input type="text" name="description" class="form-control form-control-sm" placeholder="Description">
              </div>

              <div class="col-md-1 d-flex justify-content-end gap-1">
                <button type="button" class="btn btn-warning btn-sm clear-row">Clear</button>
                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
              </div>

            </div>
          </div>

          <div class="mb-3">
            <button type="button" id="add-product" class="btn btn-secondary">+ Add Product</button>
          </div>

          <div class="text-center">
            <button class="btn btn-success" type="submit" name="action" value="save">Save</button>
            <button class="btn btn-danger" type="submit" name="action" value="delete">Delete</button>
          </div>

        </div>
      </form>
    </div>

    <hr>

    <h5>Saved Products</h5>

    {% if products %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-sm">
        <thead class="table-dark">
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Display Name</th>
            <th>HSN</th>
            <th>CGST</th>
            <th>SGST</th>
            <th>IGST</th>
            <th>Description</th>
            <th>Action</th>
          </tr>

          <!-- FILTER ROW -->
          <tr class="table-secondary">
            <th>
              <select class="form-select form-select-sm column-filter" data-col="0">
                <option value="">All</option>
                {% for i in unique_codes %}
                <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
            </th>

            <th>
              <select class="form-select form-select-sm column-filter" data-col="1">
                <option value="">All</option>
                {% for i in unique_names %}
                <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
            </th>

            <th><input type="text" class="form-control form-control-sm column-filter" data-col="2"></th>
            <th>
              <select class="form-select form-select-sm column-filter" data-col="3">
                <option value="">All</option>
                {% for i in unique_hsn %}
                <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
            </th>

            <th><input type="text" class="form-control form-control-sm column-filter" data-col="4"></th>
            <th><input type="text" class="form-control form-control-sm column-filter" data-col="5"></th>
            <th><input type="text" class="form-control form-control-sm column-filter" data-col="6"></th>
            <th><input type="text" class="form-control form-control-sm column-filter" data-col="7"></th>

            <th>
              <button type="button" id="clear-filters" class="btn btn-warning btn-sm">Clear</button>
            </th>

          </tr>
        </thead>

        <tbody>
          {% for p in products %}
          <tr>
            <td>{{ p.code }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.display_name }}</td>
            <td>{{ p.hsn }}</td>
            <td>{{ p.cgst }}</td>
            <td>{{ p.sgst }}</td>
            <td>{{ p.igst }}</td>
            <td>{{ p.description }}</td>
            <td>
              <button class="btn btn-primary btn-sm load-product" data-id="{{ p.id }}">Edit</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

    {% else %}
      <p class="text-muted">No products found.</p>
    {% endif %}

  </div>
</main>

<script>
const productContainer = document.getElementById("product-rows");

// ADD ROW
document.getElementById("add-product").addEventListener("click", function () {
  const firstRow = productContainer.querySelector(".product-row");
  const newRow = firstRow.cloneNode(true);

  newRow.querySelectorAll("input").forEach(i => i.value = "");
  productContainer.appendChild(newRow);
});

// CLEAR ROW
document.addEventListener("click", e => {
  if (e.target.classList.contains("clear-row")) {
    const row = e.target.closest(".product-row");
    row.querySelectorAll("input").forEach(i => i.value = "");
  }
});

// DELETE ROW
document.addEventListener("click", e => {
  if (e.target.classList.contains("delete-row")) {
    const rows = document.querySelectorAll(".product-row");
    if (rows.length <= 1) {
      alert("At least one row must remain!");
      return;
    }
    e.target.closest(".product-row").remove();
  }
});

// LOAD PRODUCT DATA
document.addEventListener("click", function (e) {
  if (!e.target.classList.contains("load-product")) return;

  const id = e.target.dataset.id;

  fetch(`/invoice/products/load/${id}/`)
    .then(res => res.json())
    .then(data => {
      const row = productContainer.querySelector(".product-row");
      row.querySelector('input[name="code"]').value = data.code;
      row.querySelector('input[name="name"]').value = data.name;
      row.querySelector('input[name="display_name"]').value = data.display_name;
      row.querySelector('input[name="hsn"]').value = data.hsn;
      row.querySelector('input[name="cgst"]').value = data.cgst;
      row.querySelector('input[name="sgst"]').value = data.sgst;
      row.querySelector('input[name="igst"]').value = data.igst;
      row.querySelector('input[name="description"]').value = data.description;

      const collapse = bootstrap.Collapse.getInstance(document.getElementById("productForm"))
        || new bootstrap.Collapse(document.getElementById("productForm"), { toggle: false });

      collapse.show();
    });
});

// FILTER TABLE
document.querySelectorAll(".column-filter").forEach(f => {
  f.addEventListener("input", filterTable);
  f.addEventListener("change", filterTable);
});

function filterTable() {
  const rows = document.querySelectorAll("tbody tr");

  rows.forEach(row => {
    let visible = true;
    document.querySelectorAll(".column-filter").forEach(filter => {
      const value = filter.value.toLowerCase().trim();
      const col = filter.dataset.col;
      const text = row.children[col].textContent.toLowerCase().trim();

      if (value !== "") {
        if (filter.tagName === "SELECT") {
          if (text !== value) visible = false;
        } else {
          if (!text.includes(value)) visible = false;
        }
      }
    });

    row.style.display = visible ? "" : "none";
  });
}

document.getElementById("clear-filters").addEventListener("click", function () {
  document.querySelectorAll(".column-filter").forEach(f => f.value = "");
  filterTable();
});
</script>

{% endblock %}
